{% extends "portal/base.html" %}
{% load static %}
{% block css %}
	<link rel="stylesheet" href="{% static 'portal/css/addSparePart.css' %}">
{% endblock %}
{% block title %}Create Warranty Claim{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-header fw-semibold">New Warranty Claim</div>
  <div class="card-body">
    <style>
      /* Style-only tweaks for this form */
      .errorlist { margin: 0.25rem 0 0; padding-left: 1rem; }
      .errorlist li { color: #dc3545; font-size: .875rem; }
      #partsTable thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 1; }
      #partsTable td, #partsTable th { vertical-align: middle; }
      .section-heading { display: flex; align-items: center; justify-content: space-between; gap: .75rem; }
      .section-heading h5 { margin: 0; padding-bottom: .25rem; border-bottom: 1px solid #dee2e6; }
    </style>

    <form method="post" class="row g-3" id="create_claim">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <!-- Warranty Information -->
      <div class="col-12">
        <h5 class="border-bottom pb-2 mb-2">Warranty Information</h5>
      </div>
      <div class="col-md-6">
        <label for="{{ WarrantForm.customer.id }}" class="mb-1 small text-muted">{{ WarrantForm.customer.label }}</label>
        {{ WarrantForm.customer }}
        {{ WarrantForm.customer.errors }}
      </div>
      <div class="col-md-6">
        <label for="{{ WarrantForm.claim_type.id_for_label }}" class="mb-1 small text-muted">{{ WarrantForm.claim_type.label }}</label>
        {{ WarrantForm.claim_type }}
        {{ WarrantForm.claim_type.errors }}
      </div>

      <!-- Vehicle Information -->
      <div class="col-12 mt-3">
        <h5 class="border-bottom pb-2 mb-2">Vehicle Information</h5>
      </div>
      {% for field in WarrantForm.visible_fields %}
        {% if "vehicle" in field.name|lower and "defect" not in field.name|lower %}
          <div class="col-md-6">
            <label for="{{ field.id_for_label }}" class="mb-1 small text-muted">{{ field.label }}</label>
            {{ field }}
            {{ field.errors }}
          </div>
        {% endif %}
      {% endfor %}

      <!-- Defect Information -->
      <div class="col-12 mt-3">
        <h5 class="border-bottom pb-2 mb-2">Defect Information</h5>
      </div>
      {% for field in WarrantForm.visible_fields %}
        {% if "defect" in field.name|lower %}
          <div class="col-12">
            <label for="{{ field.id_for_label }}" class="mb-1 small text-muted">{{ field.label_tag}}</label>
            {{ field }}
            {{ field.errors }}
          </div>
        {% endif %}
      {% endfor %}
        <input type="hidden" id="parts_payload" name="parts" value="[]">
	</form>
      <!-- Spare part entry by stock code -->
  <div class="col-12 mt-3">
    <h5 class="border-bottom pb-2 mb-2">Spare Parts</h5>
  </div>
    <div id="sparePartInputs" class="row g-2 align-items-end">
		  <div class="col-6 col-md-2">
		    {{ SparePartForm.stock_code.label_tag }}
		    {{ SparePartForm.stock_code }}
		    {{ SparePartForm.stock_code.errors }}
		  </div>
		  <div class="col-6 col-md-2">
		    {{ SparePartForm.quantity.label_tag }}
		    {{ SparePartForm.quantity }}
		    {{ SparePartForm.quantity.errors }}
		  </div>
		  <div class="col-6 col-md-2">
		    {{ SparePartForm.currency.label_tag }}
		    {{ SparePartForm.currency }}
		    {{ SparePartForm.currency.errors }}
		  </div>
		  <div class="col-12 col-md-3">
		    <button type="button" class="btn btn-outline-success align-bottom mt-auto" id="addPartBtn">
		      add part
		    </button>
		  </div>
	</div>


      <div class="col-12">
        <div class="table-responsive mt-2">
          <table id="partsTable" class="table table-sm table-striped table-bordered align-middle mb-0" >
	          <colgroup>
			    <col class="col-narrow"><!-- # -->
			    <col class="col-narrow"><!-- Stock Code -->
			    <col class="col-wrap">  <!-- Description -->
			    <col class="col-narrow"><!-- Qty -->
			    <col class="col-narrow"><!-- Currency -->
			    <col class="col-narrow"><!-- Unit Price -->
			    <col class="col-narrow"><!-- Total Price -->
			  </colgroup>

            <caption class="small text-muted">Parts to be included in the claim</caption>
            <thead class="table-light">
	            <tr>
					<th>#</th>
					<th>Stock Code</th>
					<th>Description</th>
					<th>Quantity</th>
					<th>Unit Price</th>
					<th>Currency</th>
					<th>Total Price</th>
		            <th>Actions</th>
	            </tr>
            </thead>
          </table>
        </div>
      </div>

      <!-- Submit -->
      <div class="col-12">
        <hr class="mt-4 mb-3">
        <div class="d-flex gap-2">
          <button id="claim_submit"  type="submit" form="create_claim" class="btn btn-primary">Save Claim</button>
          <a href="{% url 'portal:claims' %}" class="btn btn-outline-secondary">Cancel</a>
        </div>
      </div>

  </div>
</div>
	<h1 id="code12">aaaaa</h1>

{% endblock %}
<!--this block is at the head of the base template.-->
{% block js %}
	<script>
	document.addEventListener("DOMContentLoaded", function() {
		const parts = JSON.parse('{{ parts|escapejs }}');
		const addedParts = new Map();
		const PartsTable = document.getElementById('partsTable').createTBody();
		const container = document.getElementById('sparePartInputs');
		let fields = container.querySelectorAll('input,select');
		let counter = 1;
		console.log(parts);
		const form = document.getElementById('create_claim');
	    let hidden = document.getElementById('parts_payload');
		function syncHidden() {
            hidden.value = JSON.stringify(Object.fromEntries(addedParts)
);
       }


		document.getElementById('addPartBtn').onclick = function() {
			let stck = fields[0].value;
			let qty = fields[1].value;
			let cur = fields[2].value;

			if (!stck) {alert('Please enter a stock code'); return;}
			if (!qty) {alert('Please enter a quantity'); return;}
			if (!parts[stck]) {alert('Invalid stock code'); return;}
			let desc = parts[stck].description;
			let unit_price = Number(parts[stck][`price_${cur.toLowerCase()}`]);
			let total_price = Number(qty) * unit_price;


			if (addedParts.has(stck)) {alert('Already added'); return;}



			let row = PartsTable.insertRow()
			row.insertCell(0).textContent = `${counter++}`;                     <!--id-->
			row.insertCell(1).textContent = `${stck}`;                          <!--stock_code-->
			row.insertCell(2).textContent = `${desc}`;            <!--description-->
			row.insertCell(3).textContent=	`${qty}`;                           <!-- quantity-->
			row.insertCell(4).textContent = `${unit_price.toFixed(2)}`;                         <!--unit_price-->
			row.insertCell(5).textContent = `${cur}`;                                <!--currency-->
			row.insertCell(6).textContent = `${total_price.toFixed(2)}`;              <!--total_price-->
			const actionCell = row.insertCell(7);                                   <!--actions-->
			actionCell.innerHTML = `
		        <button type="button"
		                class="btn btn-sm btn-outline-danger btn-remove"
		                aria-label="Remove"
		                data-stock="${stck}">
		          Remove
		        </button>
		     `;

			addedParts.set(stck, {
		        stock_code: stck,
		        description: desc,
		        quantity: Number(qty),
		        currency: cur,
		        unit_price: unit_price,
		        total_price: total_price
            });



			console.log(addedParts);
			fields[0].value = '';
			fields[1].value = '';

		};
		PartsTable.addEventListener('click', function (e) {
			const btn = e.target.closest('.btn-remove');
			if (!btn) return;
			const tr = btn.closest('tr');
			const stock = btn.dataset.stock || (tr?.cells?.[1]?.textContent || '').trim();

			if (stock && addedParts.has(stock)) {
				addedParts.delete(stock);
			}
			if (tr) {
				tr.remove();
			}
			// Renumber the first column and reset counter
			Array.from(PartsTable.rows).forEach((r, idx) => {
				r.cells[0].textContent = String(idx + 1);
			});
			counter = PartsTable.rows.length + 1;
	    });

		form.addEventListener('submit', function() {
			syncHidden();                                                  // CHANGED: sync once on submit
			console.log(hidden.value);
		});




	});
</script>
{% endblock %}