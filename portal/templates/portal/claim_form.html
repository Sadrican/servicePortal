{% extends "portal/base.html" %}
{% load static %}

{% block title %}Create Warranty Claim{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-header fw-semibold">New Warranty Claim</div>
  <div class="card-body">
    <form method="post" class="row g-3">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <!-- Warranty Information -->
      <div class="col-12">
        <h5 class="border-bottom pb-2">Warranty Information</h5>
      </div>
      <div class="col-md-6">
        {{ form.customer.label_tag }}{{ form.customer }}{{ form.customer.errors }}
      </div>
      <div class="col-md-6">
        {{ form.claim_type.label_tag }}{{ form.claim_type }}{{ form.claim_type.errors }}
      </div>

      <!-- Vehicle Information -->
      <div class="col-12 mt-3">
        <h5 class="border-bottom pb-2">Vehicle Information</h5>
      </div>
      {% for field in form.visible_fields %}
        {% if "vehicle" in field.name|lower and "defect" not in field.name|lower %}
          <div class="col-md-6">
            {{ field.label_tag }}{{ field }}{{ field.errors }}
          </div>
        {% endif %}
      {% endfor %}

      <!-- Defect Information -->
      <div class="col-12 mt-3">
        <h5 class="border-bottom pb-2">Defect Information</h5>
      </div>
      {% for field in form.visible_fields %}
        {% if "defect" in field.name|lower %}
          <div class="col-12">
            {{ field.label_tag }}{{ field }}{{ field.errors }}
          </div>
        {% endif %}
      {% endfor %}

      <!-- Spare part entry by stock code -->
      <div class="col-12 mt-3">
        <h5 class="border-bottom pb-2">Used Spare Parts</h5>
      </div>
      <div class="col-md-6">
        {{ spare_form.stock_code.label_tag }}{{ spare_form.stock_code }}{{ spare_form.stock_code.errors }}
      </div>
      <div class="col-md-3">
        {{ spare_form.quantity.label_tag }}{{ spare_form.quantity }}{{ spare_form.quantity.errors }}
      </div>
      <div class="col-md-3">
        {{ spare_form.currency.label_tag }}{{ spare_form.currency }}{{ spare_form.currency.errors }}
      </div>

      <div class="col-12 d-flex justify-content-between align-items-center">
        <input type="hidden" id="parts_json" name="parts_json" value="{{ parts_json|default:'' }}">
        <button type="button" id="addPartBtn" class="btn btn-outline-success btn-sm">Add Spare Part</button>
      </div>

      <div class="col-12">
        <div class="table-responsive mt-2">
          <table class="table table-sm align-middle" id="partsTable">
            <thead>
            <tr>
              <th>#</th>
              <th>Stock Code</th>
              <th>Description</th>
              <th>Qty</th>
              <th>Currency</th>
              <th>Unit Price</th>
              <th class="text-end">Actions</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Labour entry -->
      <div class="col-12 mt-4">
        <h5 class="border-bottom pb-2">Labour</h5>
      </div>
      <div class="col-md-6">
        {{ labour_form.code.label_tag }}{{ labour_form.code }}{{ labour_form.code.errors }}
      </div>
      <div class="col-md-3">
        {{ labour_form.duration.label_tag }}{{ labour_form.duration }}{{ labour_form.duration.errors }}
      </div>
      <div class="col-md-3">
        {{ labour_form.currency.label_tag }}{{ labour_form.currency }}{{ labour_form.currency.errors }}
      </div>

      <div class="col-12 d-flex justify-content-between align-items-center">
        <input type="hidden" id="labours_json" name="labours_json" value="{{ labours_json|default:'' }}">
        <button type="button" id="addLabourBtn" class="btn btn-outline-success btn-sm">Add Labour</button>
      </div>

      <div class="col-12">
        <div class="table-responsive mt-2">
          <table class="table table-sm align-middle" id="laboursTable">
            <thead>
            <tr>
              <th>#</th>
              <th>Code</th>
              <th>Description</th>
              <th>Duration</th>
              <th>Currency</th>
              <th>Unit Rate</th>
              <th class="text-end">Actions</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Submit -->
      <div class="col-12">
        <button type="submit" class="btn btn-primary">Save Claim</button>
        <a href="{% url 'portal:claims' %}" class="btn btn-outline-secondary">Cancel</a>
      </div>

      <script>
      (function(){
        // Small helpers
        const $ = s => document.querySelector(s);
        const parseJSON = v => { try { return JSON.parse(v || '[]'); } catch(_) { return []; } };
        const byId = id => document.getElementById(id);

        // Generic table manager to compact duplicated logic
        function tableManager(cfg){
          const input = byId(cfg.hiddenId);
          const tbody = $(cfg.tbodySel);
          const getItems = () => parseJSON(input.value);
          const setItems = arr => { input.value = JSON.stringify(arr); render(); };
          function render(){
            const items = getItems();
            tbody.innerHTML = '';
            items.forEach((it, idx)=>{
              const tr = document.createElement('tr');
              tr.innerHTML = cfg.rowHTML(it, idx);
              tbody.appendChild(tr);
            });
          }
          tbody.addEventListener('click', e => {
            const btn = e.target.closest('button[data-idx]');
            if(!btn) return;
            const idx = +btn.getAttribute('data-idx');
            const items = getItems();
            items.splice(idx,1);
            setItems(items);
          });
          return { getItems, setItems, render };
        }

        // Parts setup
        const stockEl = document.querySelector('[name="stock_code"]');
        const qtyEl = document.querySelector('[name="quantity"]');
        const currEl = document.querySelector('select[name="currency"]');
        const partsTbl = tableManager({
          hiddenId: 'parts_json',
          tbodySel: '#partsTable tbody',
          rowHTML: (p, idx) => `
            <td>${idx+1}</td>
            <td>${p.stock_code}</td>
            <td>${p.description || ''}</td>
            <td>${p.quantity}</td>
            <td>${p.currency}</td>
            <td>${p.unit_price != null ? p.unit_price : ''}</td>
            <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" data-idx="${idx}">Remove</button></td>`
        });
        byId('addPartBtn').addEventListener('click', () => {
          const stock = (stockEl.value || '').trim();
          const qty = parseInt(qtyEl.value || '1');
          const curr = currEl.value;
          if(!stock) return alert('Please enter a stock code.');
          const url = new URL('{% url "portal:part_info" %}', window.location.origin);
          url.searchParams.set('stock_code', stock);
          url.searchParams.set('currency', curr);
          fetch(url, {credentials: 'same-origin'})
            .then(r => { if (r.status===404) throw new Error('Stock code not found'); if(!r.ok) throw new Error('Failed to fetch part info'); return r.json(); })
            .then(info => {
              const items = partsTbl.getItems();
              items.push({ stock_code: stock, quantity: isNaN(qty)?1:Math.max(1, qty), currency: curr, description: info.description, unit_price: info.unit_price });
              partsTbl.setItems(items);
              // Clear inputs and ensure inline required are disabled once an item exists
              stockEl.value = '';
              qtyEl.value = '1';
              if (stockEl) stockEl.required = false;
              if (codeEl) codeEl.required = false;
            })
            .catch(err => alert(err.message));
        });
        partsTbl.render();

        // Labour setup
        const codeEl = document.querySelector('[name="code"]');
        const durEl = document.querySelector('[name="duration"]');
        const currLEl = document.querySelectorAll('select[name="currency"]')[1] || document.querySelector('select[name="currency"]');
        const labsTbl = tableManager({
          hiddenId: 'labours_json',
          tbodySel: '#laboursTable tbody',
          rowHTML: (l, idx) => `
            <td>${idx+1}</td>
            <td>${l.code}</td>
            <td>${l.description || ''}</td>
            <td>${l.duration}</td>
            <td>${l.currency}</td>
            <td>${l.unit_rate != null ? l.unit_rate : ''}</td>
            <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" data-idx="${idx}">Remove</button></td>`
        });
        byId('addLabourBtn').addEventListener('click', () => {
          const code = (codeEl.value || '').trim();
          const dur = parseFloat(durEl.value || '1');
          const curr = currLEl.value;
          if(!code) return alert('Please enter a labour code.');
          const url = new URL('{% url "portal:labour_info" %}', window.location.origin);
          url.searchParams.set('code', code);
          url.searchParams.set('currency', curr);
          fetch(url, {credentials: 'same-origin'})
            .then(r => { if (r.status===404) throw new Error('Labour code not found'); if(!r.ok) throw new Error('Failed to fetch labour info'); return r.json(); })
            .then(info => {
              const items = labsTbl.getItems();
              items.push({ code, duration: isNaN(dur)?1:Math.max(0.25, dur), currency: curr, description: info.description, unit_rate: info.unit_rate });
              labsTbl.setItems(items);
              // Clear inputs and ensure inline required are disabled once an item exists
              codeEl.value = '';
              durEl.value = '1';
              if (stockEl) stockEl.required = false;
              if (codeEl) codeEl.required = false;
            })
            .catch(err => alert(err.message));
        });
        labsTbl.render();

        // Submission rule: allow empty inline fields if at least one item exists
        const formEl = document.querySelector('form');
        function hasAnyItems(){
          const parts = partsTbl.getItems();
          const labs = labsTbl.getItems();
          return (Array.isArray(parts) && parts.length>0) || (Array.isArray(labs) && labs.length>0);
        }
        function syncRequired(){
          const any = hasAnyItems();
          if (stockEl) stockEl.required = !any;
          if (codeEl) codeEl.required = !any;
        }
        // Patch render to also sync required state
        const origPartsRender = partsTbl.render; partsTbl.render = () => { origPartsRender(); syncRequired(); };
        const origLabsRender = labsTbl.render; labsTbl.render = () => { origLabsRender(); syncRequired(); };
        // Also sync when user types in inline fields
        ['input','change'].forEach(ev => {
          if (stockEl) stockEl.addEventListener(ev, syncRequired);
          if (codeEl) codeEl.addEventListener(ev, syncRequired);
        });
        // Initial sync
        syncRequired();

        formEl.addEventListener('submit', function(e){
          const any = hasAnyItems();
          const inlineHasInput = ((stockEl && stockEl.value.trim()) || (codeEl && codeEl.value.trim()));
          if (!any && !inlineHasInput){
            e.preventDefault();
            alert('Please add at least one Spare Part or one Labour before saving.');
            return false;
          }
          return true;
        });
      })();
      </script>
    </form>
  </div>
</div>
{% endblock %}
